# blog_sistemas_empotrados


La constiste en crear un porgrama que emule el controlador de una màquina expendedora. 

Al iniciar la placa, en el setup() se llama a una rutina que muestra que está cargando y hace parpadear a un LED. 

EL loop() está organizado como una máquina de estados por niveles. Inicialmente comprueba si está en el modo de admin o de servicio. En el modo de servicio la fsm inicia en el estado de espera, en el que comprueba si hay alguien cerca. Cuando detecta una persona pasa al estado trabajando. En este nuevo modo, inicialmente muestra la temperatura y la humedad pero, tras 5 segundos, empieza a mostar la lista de cafés disponibles y sus precios. Al seleccionar un café, el estado pasa a preparar café, en el cual va incrementando la intensidad de la luz de un LED hasta que el café esta terminado, lo que tarda entre 4 y 8 segundos.

Si la máquina está en modo admin enciende ambos LEDs para indicarlo y empieza a mostrar el menú de admin. Este cuenta con 4 opciones. Si se selecciona la primera, muestra la humedad y la temperatura como en el inicio del estado trabajando del modo servicio. La segunda muestra la distancia que detecta el sensor de presencia que se utiliza en el estado servicio para detectar un cliente. En el tercero se muestra la cantidad de tiempo en segundos desde que se encendio la placa. Finalmente el último es el que sirve para entrar el el submenú de cambio de precio. Se puede salir de estos modos moviendo el joystic hacia la izquierda. Si el programa ha entrado en el modo de cambiar el precio de los cafés, inicialmente muestra la misma pantalla que cuando se va ha selecionar un café en el modo servicio pero, al elegirlo, solo mostrará el nombre del café a elegir y em precio provisional. Si se mueve el joystic a la izquierda se descartarán los cambios mientras que si se presiona se efectuarán, cosa que se podrá observar tando en la pantalla de modificación de precios como en el modo servicio.

Para poder tener un control fluido tanto del joystic como de los botones, he utilizado arduino threads e interrupciones hardware. El movimiento del joystic está controlado por dos threads, uno para la componente X y otro para la Y. La componente X modifica el cursor de las pantallas de servicio, admin y muestra de café además de indicar si el precio del café a de aumentar o disminuir. Esto la hace comprobando en que estado se encuentra la máquina y modificando el cursor correspondiente. La componente Y funciona similar, pero solo indicando si se debe retroceder a la pantalla de selección de café a modificar o a mostrar el menú de admin. Ambas son llamadas en el loop() cada 300 ms para que el control sea fluido pero no detecte demasiados inputs ya que podria hacer que cuando se quiere desplazar una posición se muevan varias o incluso sea preacticamente imposible pasar por las posiciones intermedias. La interrupción del botón esta configurada como CHANGE, para que detecte tanto cuando se pulsa como cuando se deja de hacerlo. Al pulsarlo se guarda el tiempo y, al soltarlo, comprueba si se han cumplido alguno de los requisitos. Si el botón se ha pulsado de 2 a 3 segundos reinicia el modo de servicio, mentras que si se pulsa más de 5 varia entre el modo admin y servicio. El botón del joystic tiene su propia interrupción. Esta comprueba en que estado se encuentra la máquina para hacer iferentes tareas. En el modi servicio solo reaccionará cuando se están mostrando los cafés y seleccionará el que se está observando para que se pase al estado preparar café. En el modo de admin inicialente sirve para seleccionar que función se ha de ejecutar, pero si está en el menú de modificar precios seleciona el precio a cambiar y si se están modificando, fija el precio para que se retorne a ver las opciones a modificar.

El programa también utilia un watchdog. Este está configurado a ejecutarse si el contador llega a 8 segundos, ya que no es un sistema crítico que deba decectar rápidamente si se ha quedado bloqueado y se reinicia al final de cada función para asegurar que no se cumple el tiempo. También se reinicia en cada ejecución del bucle de preparación de café dado que el tiempo máximo de preparación son 8 segundos por lo que podia llegar a ejetutarse si el tiempo era cercano a este.

En el repositorio hay una imagen con el esquemático del circuito.

Video de ejemplo de la ejecución: https://urjc-my.sharepoint.com/:v:/g/personal/d_lopezm_2022_alumnos_urjc_es/EXr-oEMLDD1Fg6tFUXSlfC4BRaZL7yseYzG2wUBNRnHqOg?e=HtASyK&nav=eyJyZWZlcnJhbEluZm8iOnsicmVmZXJyYWxBcHAiOiJTdHJlYW1XZWJBcHAiLCJyZWZlcnJhbFZpZXciOiJTaGFyZURpYWxvZy1MaW5rIiwicmVmZXJyYWxBcHBQbGF0Zm9ybSI6IldlYiIsInJlZmVycmFsTW9kZSI6InZpZXcifX0%3D
